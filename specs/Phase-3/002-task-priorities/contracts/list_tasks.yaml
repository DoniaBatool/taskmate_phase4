# MCP Tool Contract: list_tasks

**Version**: 2.0.0 (Priority Filtering Added)
**Feature**: 002-task-priorities
**Date**: 2026-01-01

## Tool Metadata

```yaml
name: list_tasks
description: |
  Retrieve tasks for the authenticated user with optional filtering by completion status and priority level.
  Supports natural language queries like "show me all high priority tasks" or "list incomplete low priority tasks".
  Returns tasks sorted by creation date (newest first).
version: "2.0.0"
category: task-management
```

## Input Schema

```yaml
type: object
properties:
  user_id:
    type: string
    description: Unique identifier for the authenticated user (from JWT token)
    example: "user_12345"
    required: true

  completed:
    type: boolean
    description: |
      Filter by task completion status.
      - true: Only completed tasks
      - false: Only incomplete tasks
      - omitted/null: All tasks (both completed and incomplete)
    nullable: true
    example: false
    required: false

  priority:
    type: string
    description: |
      Filter by task priority level.
      - "high": Only high priority tasks
      - "medium": Only medium priority tasks
      - "low": Only low priority tasks
      - omitted/null: All priorities

      Synonyms recognized by AI agent:
      - high: "urgent", "critical", "important"
      - medium: "normal"
      - low: "minor", "trivial"
    enum:
      - high
      - medium
      - low
    nullable: true
    example: "high"
    required: false

required:
  - user_id

additionalProperties: false
```

## Output Schema

### Success Response

```yaml
type: object
properties:
  success:
    type: boolean
    const: true
    description: Indicates successful task retrieval

  tasks:
    type: array
    description: List of tasks matching the filter criteria (sorted by created_at DESC)
    items:
      type: object
      properties:
        id:
          type: integer
          description: Unique task identifier
          example: 42

        user_id:
          type: integer
          description: ID of the user who owns this task
          example: 12345

        title:
          type: string
          description: Task title
          example: "Buy groceries for dinner"

        description:
          type: string
          nullable: true
          description: Extended task details (null if not provided)
          example: "Pick up milk, eggs, bread, and vegetables"

        completed:
          type: boolean
          description: Task completion status
          example: false

        priority:
          type: string
          description: Task priority level
          enum:
            - high
            - medium
            - low
          example: "high"

        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when task was created
          example: "2026-01-01T14:30:00.000Z"

        updated_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when task was last updated
          example: "2026-01-01T14:30:00.000Z"

      required:
        - id
        - user_id
        - title
        - description
        - completed
        - priority
        - created_at
        - updated_at

  count:
    type: integer
    description: Total number of tasks returned
    minimum: 0
    example: 5

  filters:
    type: object
    description: Applied filter criteria (for confirmation/debugging)
    properties:
      completed:
        type: boolean
        nullable: true
        example: false
      priority:
        type: string
        nullable: true
        example: "high"

  message:
    type: string
    description: Human-readable summary of results
    examples:
      - "Found 5 high priority tasks"
      - "Found 3 incomplete tasks"
      - "Found 10 tasks"
      - "No tasks found matching criteria"

required:
  - success
  - tasks
  - count
  - filters
  - message
```

### Error Response

```yaml
type: object
properties:
  success:
    type: boolean
    const: false

  error:
    type: string
    description: Error message describing what went wrong
    examples:
      - "Invalid priority: urgent. Must be 'high', 'medium', or 'low'."
      - "User not found"

  code:
    type: string
    description: Machine-readable error code
    enum:
      - INVALID_PRIORITY
      - USER_NOT_FOUND
      - DATABASE_ERROR
    example: "INVALID_PRIORITY"

required:
  - success
  - error
  - code
```

## Examples

### Example 1: List All Tasks (No Filters)

**Request**:
```json
{
  "user_id": "user_12345"
}
```

**Response**:
```json
{
  "success": true,
  "tasks": [
    {
      "id": 45,
      "user_id": 12345,
      "title": "Submit project report",
      "description": "Final draft due Friday",
      "completed": false,
      "priority": "high",
      "created_at": "2026-01-01T16:00:00.000Z",
      "updated_at": "2026-01-01T16:00:00.000Z"
    },
    {
      "id": 44,
      "user_id": 12345,
      "title": "Organize garage",
      "description": "Sort tools and clean shelves",
      "completed": false,
      "priority": "low",
      "created_at": "2026-01-01T14:40:00.000Z",
      "updated_at": "2026-01-01T14:40:00.000Z"
    },
    {
      "id": 43,
      "user_id": 12345,
      "title": "Call mom on Friday",
      "description": null,
      "completed": false,
      "priority": "medium",
      "created_at": "2026-01-01T14:35:00.000Z",
      "updated_at": "2026-01-01T14:35:00.000Z"
    }
  ],
  "count": 3,
  "filters": {
    "completed": null,
    "priority": null
  },
  "message": "Found 3 tasks"
}
```

### Example 2: Filter by High Priority Only

**Request**:
```json
{
  "user_id": "user_12345",
  "priority": "high"
}
```

**Response**:
```json
{
  "success": true,
  "tasks": [
    {
      "id": 45,
      "user_id": 12345,
      "title": "Submit project report",
      "description": "Final draft due Friday",
      "completed": false,
      "priority": "high",
      "created_at": "2026-01-01T16:00:00.000Z",
      "updated_at": "2026-01-01T16:00:00.000Z"
    },
    {
      "id": 42,
      "user_id": 12345,
      "title": "Buy groceries for dinner",
      "description": "Pick up milk, eggs, bread, and vegetables",
      "completed": false,
      "priority": "high",
      "created_at": "2026-01-01T14:30:00.000Z",
      "updated_at": "2026-01-01T15:45:00.000Z"
    }
  ],
  "count": 2,
  "filters": {
    "completed": null,
    "priority": "high"
  },
  "message": "Found 2 high priority tasks"
}
```

### Example 3: Filter by Incomplete Tasks Only

**Request**:
```json
{
  "user_id": "user_12345",
  "completed": false
}
```

**Response**:
```json
{
  "success": true,
  "tasks": [
    {
      "id": 45,
      "user_id": 12345,
      "title": "Submit project report",
      "description": "Final draft due Friday",
      "completed": false,
      "priority": "high",
      "created_at": "2026-01-01T16:00:00.000Z",
      "updated_at": "2026-01-01T16:00:00.000Z"
    },
    {
      "id": 44,
      "user_id": 12345,
      "title": "Organize garage",
      "description": "Sort tools and clean shelves",
      "completed": false,
      "priority": "low",
      "created_at": "2026-01-01T14:40:00.000Z",
      "updated_at": "2026-01-01T14:40:00.000Z"
    }
  ],
  "count": 2,
  "filters": {
    "completed": false,
    "priority": null
  },
  "message": "Found 2 incomplete tasks"
}
```

### Example 4: Filter by Priority AND Completion Status

**Request**:
```json
{
  "user_id": "user_12345",
  "completed": false,
  "priority": "low"
}
```

**Response**:
```json
{
  "success": true,
  "tasks": [
    {
      "id": 44,
      "user_id": 12345,
      "title": "Organize garage",
      "description": "Sort tools and clean shelves",
      "completed": false,
      "priority": "low",
      "created_at": "2026-01-01T14:40:00.000Z",
      "updated_at": "2026-01-01T14:40:00.000Z"
    }
  ],
  "count": 1,
  "filters": {
    "completed": false,
    "priority": "low"
  },
  "message": "Found 1 incomplete low priority task"
}
```

### Example 5: No Tasks Match Filter

**Request**:
```json
{
  "user_id": "user_12345",
  "completed": true,
  "priority": "high"
}
```

**Response**:
```json
{
  "success": true,
  "tasks": [],
  "count": 0,
  "filters": {
    "completed": true,
    "priority": "high"
  },
  "message": "No tasks found matching criteria"
}
```

### Example 6: Error - Invalid Priority

**Request**:
```json
{
  "user_id": "user_12345",
  "priority": "urgent"
}
```

**Response**:
```json
{
  "success": false,
  "error": "Invalid priority: urgent. Must be 'high', 'medium', or 'low'.",
  "code": "INVALID_PRIORITY"
}
```

## Natural Language Integration

### AI Agent System Prompt Enhancement

The AI agent MUST parse filter requests from natural language:

```
When users request task lists with filters, extract filter criteria:

Priority filters:
- "show me high priority tasks" → priority: "high"
- "list urgent tasks" → priority: "high" (synonym)
- "what are my low priority tasks" → priority: "low"
- "show medium priority tasks" → priority: "medium"

Completion filters:
- "show incomplete tasks" → completed: false
- "what tasks are done" → completed: true
- "list pending tasks" → completed: false

Combined filters:
- "show incomplete high priority tasks" → completed: false, priority: "high"
- "list all done low priority tasks" → completed: true, priority: "low"

No filters:
- "show all my tasks" → no filters
- "list tasks" → no filters
```

### Natural Language Test Cases

| User Input | Extracted Parameters | Expected Result |
|------------|---------------------|-----------------|
| "show me all high priority tasks" | priority: "high" | All user's high priority tasks |
| "list urgent tasks" | priority: "high" | All user's high priority tasks (synonym) |
| "what are my incomplete tasks" | completed: false | All user's incomplete tasks |
| "show me incomplete high priority tasks" | completed: false, priority: "high" | Incomplete high priority tasks only |
| "list all tasks" | (no filters) | All user's tasks |
| "show low priority done tasks" | completed: true, priority: "low" | Completed low priority tasks |

## Validation Rules

### Input Validation

1. **user_id** (Required):
   - MUST be non-empty string
   - MUST correspond to authenticated user from JWT token
   - If user not found → Error: USER_NOT_FOUND

2. **completed** (Optional, FR-007):
   - If provided: MUST be boolean (true or false)
   - If omitted/null → No completion filter applied (return all)
   - Type validation prevents invalid values (e.g., string "true")

3. **priority** (Optional, FR-007, FR-012):
   - If provided: MUST be one of "high", "medium", "low" (case-sensitive lowercase)
   - If invalid value → Error: INVALID_PRIORITY
   - If omitted/null → No priority filter applied (return all)

### Business Rules

1. **User Isolation**: Only return tasks belonging to authenticated user
   - All queries MUST include `WHERE user_id = ?`
   - Users cannot see other users' tasks

2. **Filter Combination**: Multiple filters use AND logic
   - `completed=false AND priority=high` returns only incomplete high priority tasks

3. **Empty Results**: No error when no tasks match filters
   - Return empty array with count=0
   - Message indicates no matches found

4. **Sort Order**: Results MUST be sorted by created_at DESC (newest first)
   - Consistent ordering for predictable UI display

## Database Interaction

### SQL Query (Simplified)

**No Filters**:
```sql
SELECT * FROM tasks
WHERE user_id = 12345
ORDER BY created_at DESC;
```

**Priority Filter Only**:
```sql
SELECT * FROM tasks
WHERE user_id = 12345 AND priority = 'high'
ORDER BY created_at DESC;
```

**Completion Filter Only**:
```sql
SELECT * FROM tasks
WHERE user_id = 12345 AND completed = false
ORDER BY created_at DESC;
```

**Both Filters**:
```sql
SELECT * FROM tasks
WHERE user_id = 12345 AND completed = false AND priority = 'high'
ORDER BY created_at DESC;
```

### Index Usage

- **No Filter**: Uses `ix_tasks_user_id` index
- **Priority Filter**: Uses `ix_tasks_user_priority` composite index (NEW in this feature)
- **Completion Filter**: Uses `ix_tasks_user_id` + table scan for completed
- **Both Filters**: Uses `ix_tasks_user_priority` + filter on completed

### Query Performance

| Filter Combination | Index Used | Expected Performance |
|-------------------|------------|---------------------|
| None | ix_tasks_user_id | <50ms for 10K tasks |
| priority only | ix_tasks_user_priority | <50ms for 10K tasks |
| completed only | ix_tasks_user_id | <100ms for 10K tasks |
| priority + completed | ix_tasks_user_priority | <100ms for 10K tasks |

## Performance Requirements

- **Response Time**: <500ms for filtered queries (SC-004: 100% accuracy)
- **Database Impact**: Single SELECT query
- **Scalability**: Supports 10,000+ tasks per user with <50ms additional latency

## Security Considerations

### Authentication
- **Requirement**: user_id MUST be extracted from validated JWT token
- **Enforcement**: Calling code (chat endpoint) validates JWT before invoking MCP tool

### Authorization
- **Requirement**: User can only list their own tasks
- **Enforcement**: WHERE clause includes `user_id = ?` check
- **Cross-User Prevention**: Different user_id → No results (not error)

### Input Sanitization
- **SQL Injection**: Prevented by SQLModel ORM (parameterized queries)
- **XSS**: Not applicable (API returns JSON, frontend handles escaping)
- **ENUM Injection**: Database ENUM type prevents invalid priority values

## Backward Compatibility

### Version 1.x → 2.0 Migration

**Breaking Changes**: None (priority parameter is optional)

**Existing Clients**:
- Can continue calling list_tasks without priority parameter
- Will receive tasks with priority field in responses (new field)
- Should update to handle new priority field and filter parameter

**New Clients**:
- SHOULD use priority filter when filtering by priority
- MUST handle all 3 priority values in task responses

## Testing Requirements

### Unit Tests

1. **Test No Filters**: Call list_tasks with only user_id → Verify all tasks returned
2. **Test High Priority Filter**: Call with priority="high" → Verify only high priority tasks
3. **Test Medium Priority Filter**: Call with priority="medium" → Verify only medium priority tasks
4. **Test Low Priority Filter**: Call with priority="low" → Verify only low priority tasks
5. **Test Invalid Priority**: Call with priority="urgent" → Verify error returned
6. **Test Combined Filters**: Call with completed=false, priority="high" → Verify intersection
7. **Test Empty Results**: Call with filters matching no tasks → Verify empty array, count=0
8. **Test Sort Order**: Verify tasks sorted by created_at DESC

### Integration Tests

1. **Test NLP Filter**: User says "show me high priority tasks" → AI extracts priority="high" → Filtered tasks returned
2. **Test NLP Synonym**: User says "list urgent tasks" → AI maps to priority="high"
3. **Test NLP Combined**: User says "show incomplete low priority tasks" → Both filters applied

### Edge Cases

1. **User with No Tasks**: `tasks=[]`, `count=0`, `message="No tasks found"`
2. **All Tasks Same Priority**: Filter for different priority → Empty results
3. **Null Priority Filter**: `priority: null` → Same as omitting (no filter)
4. **Case Sensitivity**: `priority: "High"` → Should error (must be lowercase)
5. **Empty Priority String**: `priority: ""` → Should error (not in enum)

## Filter Accuracy Guarantee (SC-004)

**Success Criterion**: Users can successfully filter tasks by priority with 100% accuracy

**Validation**:
1. Database ENUM constraint ensures only valid priority values stored
2. SQL WHERE clause provides exact matching (no fuzzy logic)
3. Index ensures query plan correctness
4. Unit tests verify all filter combinations

**Test Matrix**:
```
Total Tasks: 10 (3 high, 4 medium, 3 low)
Filter: priority="high" → Return 3 tasks (100% precision, 100% recall)
Filter: priority="medium" → Return 4 tasks (100% precision, 100% recall)
Filter: priority="low" → Return 3 tasks (100% precision, 100% recall)
```

## Changelog

### Version 2.0.0 (2026-01-01) - Priority Filtering

**Added**:
- `priority` filter parameter (optional)
- Priority field in all task objects
- New composite index `ix_tasks_user_priority` for filtering performance
- Filter confirmation in `filters` response object
- Natural language priority filtering support

**Changed**:
- Response message now includes filter summary
- Task objects always include priority field

**Performance**:
- Added composite index reduces priority filter queries from O(n) to O(log n)

**Backward Compatible**:
- Existing callers without priority filter continue to work
- All tasks returned if priority filter omitted

### Version 1.0.0 (Previous) - Initial Implementation

**Features**:
- List tasks for authenticated user
- Filter by completion status
- Sort by creation date (DESC)
- User isolation via user_id

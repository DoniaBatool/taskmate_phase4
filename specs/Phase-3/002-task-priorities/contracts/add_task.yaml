# MCP Tool Contract: add_task

**Version**: 2.0.0 (Priority Support Added)
**Feature**: 002-task-priorities
**Date**: 2026-01-01

## Tool Metadata

```yaml
name: add_task
description: |
  Create a new task for the authenticated user with optional priority level.
  Supports natural language priority extraction (e.g., "high priority task to buy groceries").
  Defaults to medium priority if not specified.
version: "2.0.0"
category: task-management
```

## Input Schema

```yaml
type: object
properties:
  user_id:
    type: string
    description: Unique identifier for the authenticated user (from JWT token)
    example: "user_12345"
    required: true

  title:
    type: string
    description: Task title or description (1-200 characters)
    minLength: 1
    maxLength: 200
    example: "Buy groceries for dinner"
    required: true

  description:
    type: string
    description: Optional extended task details or notes
    nullable: true
    example: "Pick up milk, eggs, bread, and vegetables from the store"
    required: false

  priority:
    type: string
    description: |
      Task priority level. Must be one of: "high", "medium", "low".
      Defaults to "medium" if not specified.

      Synonyms recognized by AI agent:
      - high: "urgent", "critical", "important"
      - medium: "normal", (no modifier)
      - low: "minor", "trivial", "someday"
    enum:
      - high
      - medium
      - low
    default: "medium"
    example: "high"
    required: false

required:
  - user_id
  - title

additionalProperties: false
```

## Output Schema

### Success Response

```yaml
type: object
properties:
  success:
    type: boolean
    const: true
    description: Indicates successful task creation

  task:
    type: object
    description: The created task object with all fields
    properties:
      id:
        type: integer
        description: Unique task identifier (auto-generated)
        example: 42

      user_id:
        type: integer
        description: ID of the user who owns this task
        example: 12345

      title:
        type: string
        description: Task title
        example: "Buy groceries for dinner"

      description:
        type: string
        nullable: true
        description: Extended task details (null if not provided)
        example: "Pick up milk, eggs, bread, and vegetables from the store"

      completed:
        type: boolean
        description: Task completion status (always false for new tasks)
        const: false

      priority:
        type: string
        description: Task priority level
        enum:
          - high
          - medium
          - low
        example: "high"

      created_at:
        type: string
        format: date-time
        description: ISO 8601 timestamp when task was created
        example: "2026-01-01T14:30:00.000Z"

      updated_at:
        type: string
        format: date-time
        description: ISO 8601 timestamp when task was last updated
        example: "2026-01-01T14:30:00.000Z"

    required:
      - id
      - user_id
      - title
      - description
      - completed
      - priority
      - created_at
      - updated_at

  message:
    type: string
    description: Human-readable success message
    example: "Task created successfully with high priority"

required:
  - success
  - task
  - message
```

### Error Response

```yaml
type: object
properties:
  success:
    type: boolean
    const: false

  error:
    type: string
    description: Error message describing what went wrong
    examples:
      - "Invalid priority: urgent. Must be 'high', 'medium', or 'low'."
      - "Title is required and cannot be empty"
      - "Title exceeds maximum length of 200 characters"
      - "User not found"

  code:
    type: string
    description: Machine-readable error code
    enum:
      - INVALID_PRIORITY
      - INVALID_TITLE
      - USER_NOT_FOUND
      - DATABASE_ERROR
    example: "INVALID_PRIORITY"

required:
  - success
  - error
  - code
```

## Examples

### Example 1: Create High Priority Task (Explicit Priority)

**Request**:
```json
{
  "user_id": "user_12345",
  "title": "Buy groceries for dinner",
  "description": "Pick up milk, eggs, bread, and vegetables",
  "priority": "high"
}
```

**Response**:
```json
{
  "success": true,
  "task": {
    "id": 42,
    "user_id": 12345,
    "title": "Buy groceries for dinner",
    "description": "Pick up milk, eggs, bread, and vegetables",
    "completed": false,
    "priority": "high",
    "created_at": "2026-01-01T14:30:00.000Z",
    "updated_at": "2026-01-01T14:30:00.000Z"
  },
  "message": "Task created successfully with high priority"
}
```

### Example 2: Create Task with Default Priority (No Priority Specified)

**Request**:
```json
{
  "user_id": "user_12345",
  "title": "Call mom on Friday"
}
```

**Response**:
```json
{
  "success": true,
  "task": {
    "id": 43,
    "user_id": 12345,
    "title": "Call mom on Friday",
    "description": null,
    "completed": false,
    "priority": "medium",
    "created_at": "2026-01-01T14:35:00.000Z",
    "updated_at": "2026-01-01T14:35:00.000Z"
  },
  "message": "Task created successfully with medium priority"
}
```

### Example 3: Create Low Priority Task

**Request**:
```json
{
  "user_id": "user_12345",
  "title": "Organize garage",
  "description": "Sort tools and clean shelves",
  "priority": "low"
}
```

**Response**:
```json
{
  "success": true,
  "task": {
    "id": 44,
    "user_id": 12345,
    "title": "Organize garage",
    "description": "Sort tools and clean shelves",
    "completed": false,
    "priority": "low",
    "created_at": "2026-01-01T14:40:00.000Z",
    "updated_at": "2026-01-01T14:40:00.000Z"
  },
  "message": "Task created successfully with low priority"
}
```

### Example 4: Error - Invalid Priority

**Request**:
```json
{
  "user_id": "user_12345",
  "title": "Fix production bug",
  "priority": "urgent"
}
```

**Response**:
```json
{
  "success": false,
  "error": "Invalid priority: urgent. Must be 'high', 'medium', or 'low'.",
  "code": "INVALID_PRIORITY"
}
```

## Natural Language Integration

### AI Agent System Prompt Enhancement

The AI agent MUST include priority synonym mapping:

```
When users mention task priorities, map synonyms to standard values:
- "high", "urgent", "critical", "important" → priority: "high"
- "medium", "normal" → priority: "medium"
- "low", "minor", "trivial", "someday" → priority: "low"
- No mention → priority: "medium" (default)

Examples:
- "add urgent task to fix bug" → priority: "high"
- "create task to buy milk" → priority: "medium" (default)
- "add minor task to organize files" → priority: "low"
```

### Natural Language Test Cases

| User Input | Extracted Priority | Rationale |
|------------|-------------------|-----------|
| "add high priority task to buy groceries" | high | Explicit "high" keyword |
| "create urgent task to fix production bug" | high | Synonym "urgent" maps to high |
| "add task to call mom" | medium | No priority mentioned, use default |
| "remind me to organize files someday" | low | Synonym "someday" maps to low |
| "critical: submit report by Friday" | high | Synonym "critical" maps to high |
| "add normal task to water plants" | medium | Synonym "normal" maps to medium |

## Validation Rules

### Input Validation

1. **user_id** (FR-008):
   - MUST be non-empty string
   - MUST correspond to authenticated user from JWT token
   - If user not found → Error: USER_NOT_FOUND

2. **title** (FR-002):
   - MUST be non-empty (min 1 character)
   - MUST be ≤200 characters
   - If empty → Error: INVALID_TITLE
   - If too long → Error: INVALID_TITLE

3. **description** (Optional):
   - Can be null or empty string
   - No maximum length constraint
   - Stored as-is in database

4. **priority** (FR-003, FR-012):
   - MUST be one of: "high", "medium", "low" (case-sensitive lowercase)
   - If omitted → Default to "medium"
   - If invalid value → Error: INVALID_PRIORITY
   - Database ENUM constraint provides additional validation

### Business Rules

1. **User Isolation**: Tasks MUST be scoped to authenticated user (user_id from JWT)
2. **Default Priority**: If priority not specified, MUST default to "medium" (FR-003)
3. **Immutable User**: Created task's user_id cannot be changed after creation
4. **Timestamps**: created_at and updated_at MUST be set to current timestamp
5. **Initial State**: completed MUST be false for new tasks

## Database Interaction

### SQL Query (Simplified)

```sql
INSERT INTO tasks (user_id, title, description, priority, completed, created_at, updated_at)
VALUES (
  12345,
  'Buy groceries for dinner',
  'Pick up milk, eggs, bread, and vegetables',
  'high',  -- New: priority field
  false,
  CURRENT_TIMESTAMP,
  CURRENT_TIMESTAMP
)
RETURNING *;
```

### Transaction Behavior

- **Isolation**: READ COMMITTED
- **Atomicity**: Single INSERT operation (atomic by default)
- **Error Handling**: Rollback on constraint violations (e.g., invalid user_id, invalid priority enum)

## Performance Requirements

- **Response Time**: <500ms for task creation (SC-001: <5 seconds total including NLP)
- **Database Impact**: Single INSERT query
- **Index Usage**: No index needed for INSERT (primary key auto-generated)

## Security Considerations

### Authentication
- **Requirement**: user_id MUST be extracted from validated JWT token
- **Enforcement**: Calling code (chat endpoint) validates JWT before invoking MCP tool
- **User Isolation**: MCP tool does NOT validate JWT (trusts calling code)

### Authorization
- **Requirement**: User can only create tasks for themselves
- **Enforcement**: user_id from JWT MUST match user_id parameter
- **Cross-User Prevention**: Attempting to create task for different user → Error

### Input Sanitization
- **SQL Injection**: Prevented by SQLModel ORM (parameterized queries)
- **XSS**: Not applicable (API returns JSON, frontend handles escaping)
- **ENUM Injection**: Database ENUM type prevents invalid priority values

## Backward Compatibility

### Version 1.x → 2.0 Migration

**Breaking Changes**: None (priority parameter is optional with default)

**Existing Clients**:
- Can continue calling add_task without priority parameter
- Will receive `priority: "medium"` in response (new field)
- Should update to handle new priority field in responses

**New Clients**:
- SHOULD include priority parameter when known
- MUST handle all 3 priority values in responses

## Testing Requirements

### Unit Tests

1. **Test Priority Default**: Call add_task without priority → Verify priority="medium"
2. **Test High Priority**: Call add_task with priority="high" → Verify stored correctly
3. **Test Low Priority**: Call add_task with priority="low" → Verify stored correctly
4. **Test Invalid Priority**: Call add_task with priority="urgent" → Verify error returned
5. **Test Case Sensitivity**: Call add_task with priority="High" → Verify error (must be lowercase)
6. **Test Null Priority**: Call add_task with priority=null → Verify defaults to "medium"

### Integration Tests

1. **Test NLP Extraction**: User says "add urgent task" → AI extracts priority="high" → Task created
2. **Test Default Flow**: User says "add task to buy milk" → AI uses default → Task has priority="medium"
3. **Test Synonym Recognition**: User says "critical task" → AI maps to priority="high"

### Edge Cases

1. **Empty Priority String**: `priority: ""` → Should error (not in enum)
2. **Whitespace Priority**: `priority: " high "` → Should error (exact match required)
3. **Numeric Priority**: `priority: 1` → Should error (type mismatch)
4. **Array Priority**: `priority: ["high"]` → Should error (type mismatch)

## Changelog

### Version 2.0.0 (2026-01-01) - Priority Support

**Added**:
- `priority` parameter (optional, default: "medium")
- Priority field in task response object
- Validation for priority enum values
- Error code: INVALID_PRIORITY
- Natural language synonym support documentation

**Changed**:
- Response message now includes priority information
- Task object always includes priority field (even if not specified in request)

**Backward Compatible**:
- Existing callers without priority parameter continue to work
- Default priority="medium" applied automatically

### Version 1.0.0 (Previous) - Initial Implementation

**Features**:
- Create task with title and optional description
- User isolation via user_id
- Auto-generated timestamps

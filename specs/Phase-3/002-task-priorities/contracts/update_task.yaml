# MCP Tool Contract: update_task

**Version**: 2.0.0 (Priority Support Added)
**Feature**: 002-task-priorities
**Date**: 2026-01-01

## Tool Metadata

```yaml
name: update_task
description: |
  Update an existing task's title, description, and/or priority for the authenticated user.
  Supports partial updates - only specified fields are modified.
  Validates task ownership before allowing updates.
version: "2.0.0"
category: task-management
```

## Input Schema

```yaml
type: object
properties:
  user_id:
    type: string
    description: Unique identifier for the authenticated user (from JWT token)
    example: "user_12345"
    required: true

  task_id:
    type: integer
    description: ID of the task to update
    minimum: 1
    example: 42
    required: true

  title:
    type: string
    description: New task title (1-200 characters). If omitted, title is not changed.
    minLength: 1
    maxLength: 200
    nullable: true
    example: "Buy groceries and cook dinner"
    required: false

  description:
    type: string
    description: |
      New task description. If omitted, description is not changed.
      Set to null or empty string to clear existing description.
    nullable: true
    example: "Pick up organic vegetables and grass-fed beef"
    required: false

  priority:
    type: string
    description: |
      New task priority level. If omitted, priority is not changed.
      Must be one of: "high", "medium", "low".

      Synonyms recognized by AI agent:
      - high: "urgent", "critical", "important"
      - medium: "normal"
      - low: "minor", "trivial", "someday"
    enum:
      - high
      - medium
      - low
    nullable: true
    example: "low"
    required: false

required:
  - user_id
  - task_id

additionalProperties: false
```

## Output Schema

### Success Response

```yaml
type: object
properties:
  success:
    type: boolean
    const: true
    description: Indicates successful task update

  task:
    type: object
    description: The updated task object with all current field values
    properties:
      id:
        type: integer
        description: Task identifier (unchanged)
        example: 42

      user_id:
        type: integer
        description: ID of the user who owns this task (unchanged)
        example: 12345

      title:
        type: string
        description: Current task title (updated if provided)
        example: "Buy groceries and cook dinner"

      description:
        type: string
        nullable: true
        description: Current task description (updated if provided)
        example: "Pick up organic vegetables and grass-fed beef"

      completed:
        type: boolean
        description: Task completion status (unchanged by this tool)
        example: false

      priority:
        type: string
        description: Current task priority level (updated if provided)
        enum:
          - high
          - medium
          - low
        example: "low"

      created_at:
        type: string
        format: date-time
        description: ISO 8601 timestamp when task was created (unchanged)
        example: "2026-01-01T14:30:00.000Z"

      updated_at:
        type: string
        format: date-time
        description: ISO 8601 timestamp when task was last updated (refreshed)
        example: "2026-01-01T15:45:00.000Z"

    required:
      - id
      - user_id
      - title
      - description
      - completed
      - priority
      - created_at
      - updated_at

  message:
    type: string
    description: Human-readable success message indicating what was updated
    examples:
      - "Task updated successfully (priority changed to low)"
      - "Task updated successfully (title and priority changed)"
      - "Task updated successfully (no changes)"

required:
  - success
  - task
  - message
```

### Error Response

```yaml
type: object
properties:
  success:
    type: boolean
    const: false

  error:
    type: string
    description: Error message describing what went wrong
    examples:
      - "Task not found"
      - "Unauthorized: You don't own this task"
      - "Invalid priority: urgent. Must be 'high', 'medium', or 'low'."
      - "Title exceeds maximum length of 200 characters"
      - "No fields provided for update"

  code:
    type: string
    description: Machine-readable error code
    enum:
      - TASK_NOT_FOUND
      - UNAUTHORIZED
      - INVALID_PRIORITY
      - INVALID_TITLE
      - NO_FIELDS_PROVIDED
      - DATABASE_ERROR
    example: "INVALID_PRIORITY"

required:
  - success
  - error
  - code
```

## Examples

### Example 1: Update Priority Only

**Request**:
```json
{
  "user_id": "user_12345",
  "task_id": 42,
  "priority": "low"
}
```

**Response**:
```json
{
  "success": true,
  "task": {
    "id": 42,
    "user_id": 12345,
    "title": "Buy groceries for dinner",
    "description": "Pick up milk, eggs, bread, and vegetables",
    "completed": false,
    "priority": "low",
    "created_at": "2026-01-01T14:30:00.000Z",
    "updated_at": "2026-01-01T15:45:00.000Z"
  },
  "message": "Task updated successfully (priority changed to low)"
}
```

### Example 2: Update Title and Priority

**Request**:
```json
{
  "user_id": "user_12345",
  "task_id": 42,
  "title": "Buy groceries and cook dinner",
  "priority": "high"
}
```

**Response**:
```json
{
  "success": true,
  "task": {
    "id": 42,
    "user_id": 12345,
    "title": "Buy groceries and cook dinner",
    "description": "Pick up milk, eggs, bread, and vegetables",
    "completed": false,
    "priority": "high",
    "created_at": "2026-01-01T14:30:00.000Z",
    "updated_at": "2026-01-01T15:50:00.000Z"
  },
  "message": "Task updated successfully (title and priority changed)"
}
```

### Example 3: Update All Fields

**Request**:
```json
{
  "user_id": "user_12345",
  "task_id": 42,
  "title": "Shop for organic groceries",
  "description": "Get vegetables, eggs, and grass-fed beef from farmers market",
  "priority": "medium"
}
```

**Response**:
```json
{
  "success": true,
  "task": {
    "id": 42,
    "user_id": 12345,
    "title": "Shop for organic groceries",
    "description": "Get vegetables, eggs, and grass-fed beef from farmers market",
    "completed": false,
    "priority": "medium",
    "created_at": "2026-01-01T14:30:00.000Z",
    "updated_at": "2026-01-01T16:00:00.000Z"
  },
  "message": "Task updated successfully (title, description, and priority changed)"
}
```

### Example 4: Clear Description, Keep Priority

**Request**:
```json
{
  "user_id": "user_12345",
  "task_id": 42,
  "description": null
}
```

**Response**:
```json
{
  "success": true,
  "task": {
    "id": 42,
    "user_id": 12345,
    "title": "Buy groceries for dinner",
    "description": null,
    "completed": false,
    "priority": "high",
    "created_at": "2026-01-01T14:30:00.000Z",
    "updated_at": "2026-01-01T16:10:00.000Z"
  },
  "message": "Task updated successfully (description cleared)"
}
```

### Example 5: Error - Task Not Found

**Request**:
```json
{
  "user_id": "user_12345",
  "task_id": 9999,
  "priority": "high"
}
```

**Response**:
```json
{
  "success": false,
  "error": "Task not found",
  "code": "TASK_NOT_FOUND"
}
```

### Example 6: Error - Unauthorized (Different User's Task)

**Request**:
```json
{
  "user_id": "user_12345",
  "task_id": 100,
  "priority": "high"
}
```

**Response** (assuming task 100 belongs to user_67890):
```json
{
  "success": false,
  "error": "Unauthorized: You don't own this task",
  "code": "UNAUTHORIZED"
}
```

### Example 7: Error - Invalid Priority

**Request**:
```json
{
  "user_id": "user_12345",
  "task_id": 42,
  "priority": "critical"
}
```

**Response**:
```json
{
  "success": false,
  "error": "Invalid priority: critical. Must be 'high', 'medium', or 'low'.",
  "code": "INVALID_PRIORITY"
}
```

### Example 8: Idempotent Update (Same Priority)

**Request**:
```json
{
  "user_id": "user_12345",
  "task_id": 42,
  "priority": "high"
}
```

**Response** (task already has priority="high"):
```json
{
  "success": true,
  "task": {
    "id": 42,
    "user_id": 12345,
    "title": "Buy groceries for dinner",
    "description": "Pick up milk, eggs, bread, and vegetables",
    "completed": false,
    "priority": "high",
    "created_at": "2026-01-01T14:30:00.000Z",
    "updated_at": "2026-01-01T16:20:00.000Z"
  },
  "message": "Task updated successfully (no changes)"
}
```

## Natural Language Integration

### AI Agent System Prompt Enhancement

The AI agent MUST handle priority update requests:

```
When users request priority changes, extract task ID and new priority:
- "change task 5 to high priority" → task_id: 5, priority: "high"
- "make task 10 low priority" → task_id: 10, priority: "low"
- "update task 3 priority to urgent" → task_id: 3, priority: "high" (synonym)
- "set task 7 as normal priority" → task_id: 7, priority: "medium" (synonym)

Synonym mapping (same as add_task):
- high: "urgent", "critical", "important"
- medium: "normal"
- low: "minor", "trivial", "someday"
```

### Natural Language Test Cases

| User Input | Extracted Parameters | Rationale |
|------------|---------------------|-----------|
| "change task 5 to high priority" | task_id: 5, priority: "high" | Explicit task ID and priority |
| "make task 10 urgent" | task_id: 10, priority: "high" | Synonym "urgent" maps to high |
| "update task 3 priority to low" | task_id: 3, priority: "low" | Explicit low priority |
| "set task 7 as normal" | task_id: 7, priority: "medium" | Synonym "normal" maps to medium |
| "change groceries task to low priority" | Ambiguous: requires task lookup | Multiple tasks may match "groceries" |

## Validation Rules

### Input Validation

1. **user_id** (Required):
   - MUST be non-empty string
   - MUST correspond to authenticated user from JWT token
   - If user not found → Error: UNAUTHORIZED

2. **task_id** (Required):
   - MUST be positive integer (≥1)
   - MUST reference existing task
   - If task not found → Error: TASK_NOT_FOUND
   - If task belongs to different user → Error: UNAUTHORIZED

3. **title** (Optional):
   - If provided: MUST be non-empty (min 1 character) and ≤200 characters
   - If empty string → Error: INVALID_TITLE
   - If too long → Error: INVALID_TITLE
   - If omitted → Title not changed

4. **description** (Optional):
   - Can be null (clears existing description)
   - Can be empty string (clears existing description)
   - Can be new text (updates description)
   - If omitted → Description not changed

5. **priority** (Optional, FR-004, FR-012):
   - If provided: MUST be one of "high", "medium", "low" (case-sensitive lowercase)
   - If invalid value → Error: INVALID_PRIORITY
   - If omitted → Priority not changed
   - Same value as current → Idempotent (no error, updated_at refreshed)

### Business Rules

1. **User Isolation**: Users MUST only update their own tasks
   - Verify task.user_id == authenticated user_id
   - Cross-user updates → Error: UNAUTHORIZED

2. **Partial Updates**: Only specified fields are updated
   - Omitted fields retain current values
   - Explicitly null description clears existing value

3. **Timestamp Update**: updated_at MUST be refreshed on every update (even if no fields changed)

4. **Atomic Updates**: All field updates occur in single transaction
   - Either all fields update or none (rollback on error)

5. **Task Ownership Immutable**: user_id cannot be changed via update

## Database Interaction

### SQL Query (Simplified)

```sql
-- Step 1: Verify task exists and user owns it
SELECT * FROM tasks WHERE id = 42 AND user_id = 12345;

-- Step 2: Update specified fields
UPDATE tasks
SET
  priority = 'low',  -- New: priority update
  updated_at = CURRENT_TIMESTAMP
WHERE id = 42 AND user_id = 12345
RETURNING *;
```

### Transaction Behavior

- **Isolation**: READ COMMITTED
- **Atomicity**: Single UPDATE operation (atomic by default)
- **Concurrency**: Row-level locking during update
- **Error Handling**: Rollback on constraint violations (e.g., invalid priority enum)

## Performance Requirements

- **Response Time**: <500ms for task update (SC-006: <2 seconds total including NLP)
- **Database Impact**: 1 SELECT + 1 UPDATE query
- **Index Usage**: Primary key index for task lookup

## Security Considerations

### Authentication
- **Requirement**: user_id MUST be extracted from validated JWT token
- **Enforcement**: Calling code (chat endpoint) validates JWT before invoking MCP tool

### Authorization
- **Requirement**: User can only update their own tasks
- **Enforcement**: WHERE clause includes `user_id = ?` check
- **Cross-User Prevention**: Different user_id → Error: UNAUTHORIZED

### Input Sanitization
- **SQL Injection**: Prevented by SQLModel ORM (parameterized queries)
- **XSS**: Not applicable (API returns JSON, frontend handles escaping)
- **ENUM Injection**: Database ENUM type prevents invalid priority values

## Backward Compatibility

### Version 1.x → 2.0 Migration

**Breaking Changes**: None (priority parameter is optional)

**Existing Clients**:
- Can continue calling update_task without priority parameter
- Will receive updated task with priority field in response
- Should update to handle new priority field in responses

**New Clients**:
- SHOULD include priority parameter when updating priority
- MUST handle all 3 priority values in responses

## Testing Requirements

### Unit Tests

1. **Test Priority Update**: Update task priority to "low" → Verify stored correctly
2. **Test Priority Change**: Change priority from "high" to "medium" → Verify transition
3. **Test Invalid Priority**: Update with priority="urgent" → Verify error
4. **Test Priority Omitted**: Update title without priority → Verify priority unchanged
5. **Test Unauthorized**: User A updates User B's task → Verify error
6. **Test Task Not Found**: Update non-existent task → Verify error
7. **Test Idempotent**: Update priority to same value → Verify success, updated_at refreshed

### Integration Tests

1. **Test NLP Update**: User says "change task 5 to high priority" → Task priority updated
2. **Test Synonym**: User says "make task 10 urgent" → Priority updated to "high"
3. **Test Multi-Field**: User says "change task 3 title to X and make it low priority" → Both updated

### Edge Cases

1. **Empty Priority String**: `priority: ""` → Should error (not in enum)
2. **Null Priority**: `priority: null` → Should NOT update priority (omitted field)
3. **Case Sensitivity**: `priority: "High"` → Should error (must be lowercase)
4. **Concurrent Updates**: Two users update different tasks simultaneously → Both succeed
5. **Update After Complete**: Update priority of completed task → Should succeed (priority independent of completion)

## Change Detection

### Fields Changed Tracking

The response message SHOULD indicate which fields were updated:

**Logic**:
```python
changed_fields = []
if old_task.title != new_task.title:
    changed_fields.append("title")
if old_task.description != new_task.description:
    changed_fields.append("description")
if old_task.priority != new_task.priority:
    changed_fields.append("priority")

if not changed_fields:
    message = "Task updated successfully (no changes)"
else:
    message = f"Task updated successfully ({', '.join(changed_fields)} changed)"
```

## Changelog

### Version 2.0.0 (2026-01-01) - Priority Support

**Added**:
- `priority` parameter (optional)
- Priority change detection in response message
- Validation for priority enum values
- Error code: INVALID_PRIORITY
- Natural language synonym support for priority updates

**Changed**:
- Response message now indicates which fields changed (including priority)
- Task object always includes priority field in response

**Backward Compatible**:
- Existing callers without priority parameter continue to work
- Priority field not updated if parameter omitted

### Version 1.0.0 (Previous) - Initial Implementation

**Features**:
- Update task title and description
- User isolation via user_id
- Partial updates (only specified fields changed)
- Timestamp refresh on updates
